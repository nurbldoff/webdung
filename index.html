<html><head>
    <title>WebGL Demo</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="webgl.css" type="text/css">
    <script type="text/javascript" src="jquery-1.6.1.js"></script>
    <script src="sylvester.js" type="text/javascript"></script>
    <script src="glUtils.js" type="text/javascript"></script>
    <script src="webdung.js" type="text/javascript"></script>

    <!-- Fragment shader program -->



    <!-- Vertex shader program -->

    <script id="shader-view-vs" type="x-shader/x-vertex">
      attribute highp vec3 aVertexNormal;
      attribute highp vec3 aVertexPosition;
      attribute highp vec2 aTextureCoord;

      uniform highp mat4 uNormalMatrix;
      uniform highp mat4 uMVMatrix;
      uniform highp mat4 uPMatrix;

      varying highp vec2 vTextureCoord;
      varying highp vec3 vLighting;

      void main(void) {
        gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
        vTextureCoord = aTextureCoord;

        // Apply lighting effect

        highp vec3 ambientLight = vec3(0.6, 0.6, 0.6);
        highp vec3 directionalLightColor = vec3(0.5, 0.5, 0.75);
        highp vec3 directionalVector = vec3(0.85, 0.8, 0.75);

        highp vec4 transformedNormal = uNormalMatrix * vec4(aVertexNormal, 1.0);

        highp float directional = max(dot(transformedNormal.xyz, directionalVector), 0.0);
        vLighting = ambientLight + (directionalLightColor * directional);
      }
    </script>

    <script id="shader-view-fs" type="x-shader/x-fragment">
      varying highp vec2 vTextureCoord;
      varying highp vec3 vLighting;

      uniform sampler2D uSampler;

      highp float a = .35;
      highp float x, y, p, p2, d;

      void main(void) {
        x = vTextureCoord.s*2.-1.;
        y = vTextureCoord.t*2.-1.;
        p2 = (x*x + y*y);
        p = sqrt(p2);
        d = pow(p/(1.0-a*p2),2.);
        x = ((x / (1.-a*d))+1.)*.5;
        y = ((y / (1.-a*d))+1.)*.5;

        highp vec4 texelColor = texture2D(uSampler, vec2(x, y));

        gl_FragColor = vec4(texelColor.rgb * vLighting, texelColor.a);
      }
  </script>


  <script id="shader-vs" type="x-shader/x-vertex">
    #ifdef GL_ES
    precision highp float;
    #endif

    attribute highp vec3 aVertexNormal;
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;
    attribute highp vec3 aWorldPosition;

    uniform highp mat4 uNormalMatrix;
    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;

    varying highp vec4 vTransformedNormal, vVertex;
    varying vec3 vVertexPosition, vWorldPosition, vNormal;
    varying highp vec2 vTextureCoord;
    varying highp float fogFactor, fogDistance, surfaceCosine;

    void main(void) {
        vVertex = uMVMatrix * vec4(aVertexPosition+aWorldPosition, 1.0);
        //if (vVertex.z < 0.0) {
        //    vVertex.z = -log(-vVertex.z);
        //}
        gl_Position = uPMatrix * vVertex;

        vTransformedNormal = uNormalMatrix * vec4(aVertexNormal, 1.0);
        surfaceCosine = abs(dot(normalize(vTransformedNormal.xyz), normalize(vVertex.xyz)));

        vec4 vCenter = uMVMatrix * vec4(aWorldPosition+aVertexNormal*0.5, 1.0);
        highp vec3 a = cross( normalize(vCenter.xyz), normalize(vTransformedNormal.xyz));

        float centerCosine = abs(dot(normalize(vCenter.xyz), vTransformedNormal.xyz));
        vTextureCoord.x = aTextureCoord.x*0.25 + 0.25;
        if (vTransformedNormal.y == 0.) {
            if (centerCosine < 0.90) {
                vTextureCoord.x = vTextureCoord.x-sign(a.y)*0.25;
            }
        } else {
            vTextureCoord.x = vTextureCoord.x;
        }
        vTextureCoord.y = aTextureCoord.y;

        fogDistance = length(vVertex);
        fogFactor = exp2( -.15 * .15 * fogDistance*fogDistance );
        fogFactor = clamp(fogFactor, 0.0, 1.0);

        vWorldPosition = aWorldPosition;
        vVertexPosition = aVertexPosition;
        vNormal = aVertexNormal;
    }
    </script>

<script id="shader-fs" type="x-shader/x-fragment">
    #ifdef GL_ES
    precision highp float;
    #endif
      varying highp vec2 vTextureCoord;
      varying highp vec4 vTransformedNormal, vVertex;
      varying highp vec3 vWorldPosition, vVertexPosition, vNormal;
      varying highp float surfaceCosine;
      varying float fogFactor;

      uniform sampler2D uSampler, uSamplerLightmap;

      void main(void) {
        //gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
        //float surfaceCosine2 = max(dot(vTransformedNormal.xyz, normalize(-vVertex).xyz), 0.0);

        vec2 lightmapPosition = vec2((vWorldPosition.x+vVertexPosition.x+.5)/16.0,
                                    ((vWorldPosition.z+vVertexPosition.z+0.5)-16.0)/16.0);
        //if(abs(vVertexPosition.y) < 0.1) {
        //lightmapPosition += vec2(vNormal.x/16.0, vNormal.z/16.0)*(0.5-abs(vVertexPosition.y));
        //}
        vec4 light = texture2D(uSamplerLightmap, lightmapPosition);
        vec4 texelColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
        gl_FragColor = vec4(texelColor.rgb*light.rgb*(surfaceCosine*0.5+0.5), texelColor.a);
        //gl_FragColor = vec4(vec3(1.0, 1.0, 1.0)*light.rgb*(surfaceCosine*0.5+0.5), texelColor.a);

      }
    </script>

  <script id="shader-wall-vs" type="x-shader/x-vertex">
    #ifdef GL_ES
    precision highp float;
    #endif
      attribute highp vec3 aVertexNormal;
      attribute highp vec3 aVertexPosition;
      attribute highp vec2 aTextureCoord;
      attribute highp vec3 aWorldPosition;

      uniform highp mat4 uNormalMatrix;
      uniform highp mat4 uMVMatrix;
      uniform highp mat4 uPMatrix;

      varying highp vec2 vTextureCoord;
      varying highp vec3 vLighting;
      varying highp vec4 vTransformedNormal, vVertex;
      varying highp float fogFactor, fogDistance, surfaceCosine;


      void main(void) {
        vVertex = uMVMatrix * vec4(aVertexPosition+aWorldPosition, 1.0);
        gl_Position = uPMatrix * vVertex;

        // Apply lighting effect

        highp vec3 ambientLight = vec3(0.6, 0.6, 0.6);
        highp vec3 directionalLightColor = vec3(0.5, 0.5, 0.75);
        highp vec3 directionalVector = vec3(0.85, 0.8, 0.75);

        vTransformedNormal = uNormalMatrix * vec4(aVertexNormal, 1.0);

        //highp float directional = max(dot(vTransformedNormal.xyz, directionalVector), 0.0);
        highp float directional = max(dot(vTransformedNormal.xyz, directionalVector), 0.0);
        vLighting = ambientLight + (directionalLightColor * directional);
        fogDistance = length(vVertex);
        fogFactor = exp2( -.25 * .25 * fogDistance*fogDistance );
        fogFactor = clamp(fogFactor, 0.0, 1.0);

        surfaceCosine = abs(dot(vTransformedNormal.xyz, normalize(vVertex).xyz));
        vec4 vCenter = uMVMatrix * vec4(aWorldPosition, 1.0);
        float centerCosine = abs(dot(normalize(vCenter).xyz, vTransformedNormal.xyz));

        highp vec3 a = cross( normalize(vCenter).xyz, vTransformedNormal.xyz);
        //vTextureCoord = aTextureCoord;
        vTextureCoord.x = aTextureCoord.x*0.25 + 0.25;
        if (vTransformedNormal.y == 0.) {
            if (centerCosine < 0.85) {
                vTextureCoord.x = vTextureCoord.x-sign(a.y)*0.25;
            }
        } else {
            vTextureCoord.x = vTextureCoord.x+.5;
        }
        //gl_TexCoord[0].x = gl_MultiTexCoord0.x;
        vTextureCoord.y = aTextureCoord.y;
        //surfaceCosine = abs(surfaceCosine);
      }
    </script>

  <script id="shader-wall-fs" type="x-shader/x-fragment">
    #ifdef GL_ES
    precision highp float;
    #endif

      varying highp vec2 vTextureCoord;
      varying highp vec3 vLighting;
      varying highp vec4 vTransformedNormal, vVertex;
      varying float fogFactor; // surfaceCosine;
      uniform sampler2D uSampler;

      void main(void) {

        if(fogFactor < 0.) {    // don't draw anything that would be black anyway
            discard;
        }
        float surfaceCosine2 = max(dot(vTransformedNormal.xyz, normalize(-vVertex).xyz), 0.0);
        vec4 texelColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));

        gl_FragColor = vec4(texelColor.rgb * surfaceCosine2 * fogFactor, texelColor.a);
      }
    </script>
  </head>

  <body onload="start()">
    <canvas id="glcanvas" width="500" height="500">
      Your browser doesn't appear to support the HTML5 <code>&lt;canvas&gt;</code> element.
    </canvas>

    <font size="40">
    <table>
      <tr>
        <td> <button id="turn_left" type="button">q</button> </td>
        <td> <button id="move_forward" type="button">w</button> </td>
        <td> <button id="turn_right" type="button">e</button> </td>
       </tr>
      <tr>
        <td> <button id="move_left" type="button">a</button> </td>
        <td> <button id="move_backward" type="button">s</button> </td>
        <td> <button id="move_right" type="button">d</button> </td>
       </tr>
    </table>
    </font>
    <p>FPS:<span id="fps">0</span>

</body></html>
